{"version":3,"sources":["frontend/extensions/calc.cljc"],"mappings":";AAeS,iCAAA,AAAAA,jCAAWC,wDAAM;AAE1B,4CAAA,5CAAMC,gGAAYC;AAAlB,AAEW,qBAAWC,bAASD;;AAE/B,0CAAA,1CAAME,4FAAUC;AAAhB,AACE,SAAI,AAACC,+BAAeD,QAAG,AAACJ,0CAAWI;;AAErC,mCAAA,nCAAME;AAAN,AAAiB,oDAAA,7CAACC;;AAElB,sCAAA,tCAAMC,oFAAOC,IAAIC;AAAjB,AACE,IAAAC,WAAA,wCAAA,qDAAA,mDAAA,6DAAA,mDAAA,yDAAA,oDAAA,iDAAA,oDAAA,gEAAA,qDAAA,mDAAA,mDAAA,oDAAA,iDAAA,iEAAA,2DAAA,4DAAA,kDAAA,yDAAA,sDAAA,sDAsBc,qDAAUQ;AAAV,AACwC,OAACY,UAAaZ;GALtD,oDAASA;AAAT,AACuC,OAACU,SAAYV;GAapD,wDAAae;AAAb,AACE,IAAMA,WAAI,AAACI,oBAASJ;AAApB,AACE,IAAAK,mBAAI,4CAAA,AAAAC,5CAACC,4DAAKhC,KAAIyB;AAAd,AAAA,oBAAAK;AAAAA;;AACI,MACC,oMAAA,2CAAA,/OAACG,gDAAQ,0DAAA,1DAACC,qIAAqCT,6GAChCA;;GAjBxB,oDAASf;AAAT,AACuC,OAACW,SAAYX;GApBpD,qEAAA,WAAAJ,hFAACC,6CAAKC;AAAN,AAAuB,8BAAAF,iBAAA,IAAA,5CAACG;IAMxBI,YAOA,mDAAQH;AAAR,AACuC,OAACQ,SAAYR;GALpD,oDAASA,EAAEK;AAAX,AACyC,OAACC,SAAYN,EAAEK;GARxDP,wBAqBA,qDAAUE;AAAV,AACwC,OAACa,UAAab;GAzBpEP,mCAKcQ,jBAGAG,oCAQA,oDAASJ;AAAT,AACuC,OAACS,SAAYT;GAWpD,6DAAae,KAAIC;AAAjB,AACE,AAACC,mDAAM3B,IAAI4B,gBAAMH,KAAIC;;AACrBA;GA5BF,wDAAahB;AAAb,AAAgB,YAAA,JAAGA;wCAEnB,oDAASA,rEAETE,pBAyBAiB;AA3BA,AAAY,UAAGnB;GAsBf,qDAAUA;AAAV,AACwC,OAACc,UAAad;GAftD,oDAASA;AAAT,AACyC,OAACO,WAAcP;;IAbtEN,WAsCCH;AAtCD,AAAA,0HAAAC,SAAAE,gDAAAF,SAAAE,pLAACC,0DAAAA,6EAAAA;;AAwCH,AAAA,gCAAA,wCAAA8B,xEAAME;AAAN,AAAA,IAAAD,WAAA,AAAA;AAAA,AAAA,QAAAA;KAAA;AAAA,OAAAC,4DAAA,CAAA,UAAA;;;KAAA;AAAA,OAAAA,4DAAA,CAAA,UAAA,MAAA,CAAA,UAAA;;;;AAAA,MAAA,KAAA5C,MAAA,CAAA,8DAAA,AAAA;;;;;AAAA,CAAA,8DAAA,9DAAM4C,yEACFpC;AADJ,AACS,OAACqC,4DAAK,AAACzC,mCAASI;;;AADzB,CAAA,8DAAA,9DAAMoC,yEAEFrC,IAAIC;AAFR,AAGG,IAAA,AACE,GAAI,AAACP,wCAASO;AACZA;;AACA,OAACuC,gBAAM,AAACzC,oCAAMC,IAAIC;;gBAHtB,GAAA,CAAAsC,kBAIiC9C;AAJjC,QAAA8C,JAI2C/C;AAJ3C,AAKIA;;AALJ,AAAA,MAAA+C;;;;;AAHH,CAAA,wDAAA,xDAAMF;;AAAN,AAUA,sCAAA,tCAAMI,oFAAYC;AAAlB,AAAA,GACS,OAASA;AADlB;AAAA,AAAA,MAAA,KAAAjD,MAAA;;;AAEE,IAAMO,MAAI,AAACH;AAAX,AACE,OAAC8C,6CAAK,WAAKC;AAAL,AACE,GAAU,AAACC,4BAAWD;AAAtB;;AAAA,AACE,OAACN,4DAAKtC,IAAI,CAACV,+DAAAA,qEAAAA,RAAMsD,iDAAAA;;GACrB,AAACE,2BAAgBJ;;AAMxB,mCAAA,AAAAK,oBAAAC,oBAAA,3EAAUE,sFACPE;AADH,AAAA,AAAA,OAAAH,+BAEE,iBAAAI,qBAAwB,AAACE,eAAUH;AAAnC,AAAA,oBAAAC;AAAA,AAAA,mBAAAA,fAAWC;AAAX,AAAA,0FAAA,wGAAA,2CAAA,uEAImD,WAAK9D;AAAL,AACE,OAAkBA;WAEpE,iBAAAgE,qBAAA,+CAAAC;AAAA,AAAA,YAAAC,kBAAA,KAAA;AAAA,AAAA,IAAAD,eAAAA;;AAAA,AAAA,IAAAJ,yBAAA,AAAAM,cAAAF;AAAA,AAAA,GAAAJ;AAAA,AAAA,IAAAI,eAAAJ;AAAA,AAAA,GAAA,AAAAO,6BAAAH;AAAA,IAAAI,kBAy1E2C,AAAAoB,sBAAAxB;IAz1E3CK,qBAAA,AAAAC,gBAAAF;IAAAG,WAAA,AAAAC,uBAAAH;AAAA,AAAA,GAAA,AAAA,iBAAAI,WAAA;;AAAA,AAAA,GAAA,CAAAA,WAAAJ;AAAA,IAAAK,aAAA,AAAAC,eAAAP,gBAAAK;QAAA,AAAAG,4CAAAF,WAAA,IAAA,/DAAOW;WAAP,AAAAT,4CAAAF,WAAA,IAAA,lEAASvB;AAAT,AAAA,AAAA,AAAA0B,uBAAAN,SAAA,mFAAA,uJAAA,2CAAA,8DAAA,mFAAA,7FACgEc,kJACtD,kBAAA,GAAA,iDAAA,IAAA,xEACE,SAAA,RAAMlC,oBACN,AAAClD,wCAASkD,WACYA;;;AALlC,eAAA,CAAAsB,WAAA;;;;AAAA;;;;;AAAA,OAAAK,qBAAA,AAAAC,gBAAAR,UAAA,AAAAS,qCAAA,AAAAC,qBAAAjB;;AAAA,OAAAc,qBAAA,AAAAC,gBAAAR,UAAA;;;AAAA,IAAAW,aAAA,AAAAnC,gBAAAiB;QAAA,AAAAY,4CAAAM,WAAA,IAAA,/DAAOG;WAAP,AAAAT,4CAAAM,WAAA,IAAA,lEAAS/B;AAAT,AAAA,OAAAgC,eAAA,mFAAA,uJAAA,2CAAA,8DAAA,mFAAA,7FACgEE,kJACtD,kBAAA,GAAA,iDAAA,IAAA,xEACE,SAAA,RAAMlC,oBACN,AAAClD,wCAASkD,WACYA;mBALlC,AAAA6B,qCAAA,AAAAI,eAAApB;;;AAAA;;;;GAAA,KAAA;;AAAA,AAAA,OAAAD,mBAAe,AAACuB,oDAAYC,iBAAO1B;;;AAPtC;;;GAFF,6GAAA,1BAAoBH","names":["instaparse.core/parser","frontend.extensions.calc/parse","frontend.extensions.calc/exception?","e","js/Error","frontend.extensions.calc/failure?","v","instaparse.core/failure?","frontend.extensions.calc/new-env","cljs.core.atom","frontend.extensions.calc/eval*","env","ast","G__77761","cljs.core//","G__77762","instaparse.core/transform","p1__77760#","cljs.core.comp","clojure.edn/read-string","clojure.string/replace","a","cljs.core/identity","cljs.core/+","cljs.core/-","cljs.core/*","b","js/Math.pow","js/Math.log10","js/Math.log","js/Math.sin","js/Math.cos","js/Math.tan","js/Math.atan","js/Math.asin","js/Math.acos","var","val","cljs.core.swap_BANG_","cljs.core/assoc","clojure.string/trim","or__4253__auto__","cljs.core/deref","cljs.core.get","cljs.core.ex_info","frontend.util.format","var_args","G__77764","frontend.extensions.calc/eval","frontend.extensions.calc.eval","e77765","cljs.core/first","frontend.extensions.calc/eval-lines","s","cljs.core.mapv","line","clojure.string/blank?","clojure.string/split-lines","rum.core/lazy-build","rum.core/build-defc","daiquiri.interpreter/interpret","frontend.extensions.calc/results","rum.core/reactive","calc-atom","temp__5720__auto__","output-lines","rum.core/react","iter__4652__auto__","s__77777","cljs.core/LazySeq","cljs.core/seq","cljs.core/chunked-seq?","c__4650__auto__","size__4651__auto__","cljs.core/count","b__77779","cljs.core/chunk-buffer","i__77778","vec__77780","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__77776","cljs.core/chunk-rest","vec__77783","cljs.core/cons","cljs.core/rest","i","cljs.core.map_indexed","cljs.core/vector","cljs.core/chunk-first"],"sourcesContent":["(ns frontend.extensions.calc\n  (:refer-clojure :exclude [eval])\n  (:require [clojure.edn :as edn]\n            [clojure.string :as str]\n            [frontend.util :as util]\n            #?(:clj [clojure.java.io :as io])\n            #?(:cljs [shadow.resource :as rc])\n            #?(:cljs [rum.core :as rum])\n            #?(:clj [instaparse.core :as insta]\n               :cljs [instaparse.core :as insta :refer-macros [defparser]])))\n\n;; ======================================================================\n;; Interpreter\n\n#?(:clj (def parse (insta/parser (io/resource \"grammar/calc.bnf\")))\n   :cljs (defparser parse (rc/inline \"grammar/calc.bnf\")))\n\n(defn exception? [e]\n  #?(:clj (instance? Exception e)\n     :cljs (instance? js/Error e)))\n\n(defn failure? [v]\n  (or (insta/failure? v) (exception? v)))\n\n(defn new-env [] (atom {}))\n\n(defn eval* [env ast]\n  (insta/transform\n   {:number     (comp edn/read-string #(str/replace % \",\" \"\"))\n    :percent    (fn percent [a] (/ a 100.00))\n    :scientific edn/read-string\n    :negterm    (fn neg [a] (- a))\n    :expr       identity\n    :add        +\n    :sub        -\n    :mul        *\n    :div        /\n    :pow        (fn pow [a b]\n                  #?(:clj (java.lang.Math/pow a b) :cljs (js/Math.pow a b)))\n    :log        (fn log [a]\n                  #?(:clj (java.lang.Math/log10 a) :cljs (js/Math.log10 a)))\n    :ln         (fn ln [a]\n                  #?(:clj (java.lang.Math/log a) :cljs (js/Math.log a)))\n    :sin        (fn sin [a]\n                  #?(:clj (java.lang.Math/sin a) :cljs (js/Math.sin a)))\n    :cos        (fn cos [a]\n                  #?(:clj (java.lang.Math/cos a) :cljs (js/Math.cos a)))\n    :tan        (fn tan [a]\n                  #?(:clj (java.lang.Math/tan a) :cljs (js/Math.tan a)))\n    :atan       (fn atan [a]\n                  #?(:clj (java.lang.Math/atan a) :cljs (js/Math.atan a)))\n    :asin       (fn asin [a]\n                  #?(:clj (java.lang.Math/asin a) :cljs (js/Math.asin a)))\n    :acos       (fn acos [a]\n                  #?(:clj (java.lang.Math/acos a) :cljs (js/Math.acos a)))\n    :assignment (fn assign! [var val]\n                  (swap! env assoc var val)\n                  val)\n    :toassign   str/trim\n    :variable   (fn resolve [var]\n                  (let [var (str/trim var)]\n                    (or (get @env var)\n                        (throw\n                         (ex-info (util/format \"Can't find variable %s\" var)\n                                  {:var var})))))}\n   ast))\n\n(defn eval\n  ([ast] (eval (new-env) ast))\n  ([env ast]\n   (try\n     (if (failure? ast)\n       ast\n       (first (eval* env ast)))\n     (catch #?(:clj Exception :cljs js/Error) e\n       e))))\n\n(defn eval-lines [s]\n  {:pre [(string? s)]}\n  (let [env (new-env)]\n    (mapv (fn [line]\n            (when-not (str/blank? line)\n              (eval env (parse line))))\n          (str/split-lines s))))\n\n;; ======================================================================\n;; UI\n\n#?(:cljs\n   (rum/defc results < rum/reactive\n     [calc-atom]\n     (when-let [output-lines (rum/react calc-atom)]\n       ;; the editor's parent will go into edit mode if any elements are clicked\n       ;; if we stop click propagation on this element, we allow the user to\n       ;; copy and paste the calc results\n       [:div.extensions__code-calc.pr-2 {:on-mouse-down (fn [e]\n                                                          (.stopPropagation e))}\n        ;; TODO: add react keys\n        (for [[i line] (map-indexed vector output-lines)]\n          [:div.extensions__code-calc-output-line.CodeMirror-line {:key i}\n           [:span (cond\n                    (nil? line)           \"\"\n                    (failure? line) \"?\"\n                    :else                 line)]])])))\n"]}