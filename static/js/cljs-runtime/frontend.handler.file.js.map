{"version":3,"sources":["frontend/handler/file.cljs"],"mappings":"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","names":["frontend.handler.file/load-file","repo-url","path","promesa.core.bind","___42626__auto__","promesa.protocols/-promise","content","frontend.fs.read_file","frontend.config/get-repo-dir","promesa.core.catch$","e","cljs.core.println","js/console.error","frontend.handler.file/load-multiple-files","paths","cljs.core.doall","p1__62729#","cljs.core.mapv","frontend.handler.file/keep-formats","files","formats","cljs.core.filter","file","format","logseq.graph-parser.util/get-format","cljs.core/contains?","frontend.handler.file/only-text-formats","frontend.config/text-formats","frontend.handler.file/only-image-formats","frontend.config/img-formats","var_args","G__62731","frontend.handler.file/restore-config!","js/Error","project-changed-check?","frontend.handler.file.restore_config_BANG_","config-content","_project-changed-check?","frontend.handler.common/get-config","frontend.handler.common/reset-config!","frontend.handler.file/load-files-contents!","ok-handler","images","promesa.core/all","promesa.core.then","contents","file-contents","G__62734","cljs.core/zipmap","cljs.core/seq","cljs.core.merge","cljs.core.repeat","cljs.core/count","iter__4652__auto__","s__62736","cljs.core/LazySeq","temp__5720__auto__","cljs.core/chunked-seq?","c__4650__auto__","size__4651__auto__","b__62738","cljs.core/chunk-buffer","i__62737","vec__62739","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__62735","cljs.core/chunk-rest","vec__62742","cljs.core/first","cljs.core/cons","cljs.core/rest","logseq.graph-parser.util/path-normalize","error","lambdaisland.glogi.log","cljs.core/identity","frontend.handler.file/page-exists-in-another-file","page","page-name","current-file","frontend.db/get-page-file","cljs.core.not_EQ_","G__62755","frontend.handler.file/reset-file!","frontend.handler.file.reset_file_BANG_","new-graph?","electron-local-repo?","and__4251__auto__","frontend.util/electron?","frontend.config/local-db?","frontend.util/win32?","js/module$frontend$utils.win32","or__4253__auto__","frontend.mobile.util/native-android?","frontend.mobile.util/native-ios?","new?","G__62759","frontend.db/entity","frontend.db/set-file-content!","file-content","tx","logseq.graph-parser.config/mldoc-support-formats","vec__62762","pages","blocks","logseq.graph-parser.extract/extract-blocks-pages","frontend.state.get_config","frontend.state/get-date-formatter","frontend.state/page-name-order","frontend.config/get-block-pattern","frontend.config/supported-formats","G__62765","frontend.db/get-db","frontend.state/get-current-repo","first-page","delete-blocks","cljs.core.concat","frontend.db/delete-file-blocks!","G__62766","G__62767","frontend.db/delete-page-blocks","cljs.core.distinct","_","frontend.state/pub-event!","block-ids","cljs.core.map","block","block-refs-ids","cljs.core.mapcat","ref","cljs.core/vector?","cljs.core._EQ_","cljs.core/second","clojure.set.union","cljs.core/set","logseq.graph-parser.extract/with-ref-pages","pages-index","p1__62753#","cljs.core/select-keys","t","cljs-time.coerce/to-long","cljs-time.core/now","G__62778","cljs.core.assoc","G__62779","G__62780","G__62781","frontend.db/transact!","p__62782","map__62783","cljs.core/--destructure-map","cljs.core.get","frontend.handler.file/alter-file","repo","reset?","re-render-root?","from-disk?","skip-compare?","original-content","frontend.db/get-file","write-file!","promesa.core/resolved","frontend.fs/write-file!","page-id","frontend.db/get-file-page-id","G__62784","G__62785","frontend.util.p_handle","frontend.config.get_config_path","frontend.config.get_custom_css_path","frontend.handler.ui/add-style-if-exists!","frontend.handler.ui.re_render_root_BANG_","frontend.handler.file/set-file-content!","new-content","p__62796","map__62797","frontend.handler.file/alter-files","update-db?","opts","file->content","seq__62798","chunk__62799","count__62800","i__62801","vec__62808","c__4679__auto__","cljs.core/chunk-first","vec__62811","cljs.core/next","chan","frontend.state/get-file-write-chan","chan-callback","cljs.core.async.put_BANG_","p__62814","map__62815","frontend.handler.file/alter-files-handler!","finish-handler","write-file-f","p__62816","vec__62817","frontend.fs.nfs/check-directory-permission!","frontend.handler.ui/re-render-file!","frontend.handler.file/run-writes-chan!","c__41861__auto__","cljs.core.async.chan","cljs.core.async.impl.dispatch/run","f__41862__auto__","switch__41838__auto__","state_62858","state_val_62859","inst_62823","inst_62824","inst_62825","inst_62826","cljs.core/PersistentHashMap","inst_62827","inst_62828","statearr-62860","statearr-62861","inst_62822","statearr-62862","statearr-62863","inst_62850","statearr-62864","statearr-62865","inst_62837","inst_62847","statearr-62866","inst_62853","statearr-62867","statearr-62868","inst_62856","cljs.core.async.impl.ioc-helpers/return-chan","inst_62845","statearr-62869","statearr-62870","cljs.core.async.impl.ioc-helpers/take!","inst_62838","statearr-62871","cljs.core/ExceptionInfo","statearr-62872","statearr-62874","statearr-62875","statearr-62876","inst_62834","inst_62835","cljs.core.async.interop/p->c","statearr-62878","inst_62840","cljs.core/ex-data","inst_62841","inst_62842","statearr-62879","statearr-62880","ex62877","statearr-62881","statearr-62882","statearr-62883","state-machine__41839__auto__","ret-value__41840__auto__","result__41841__auto__","cljs.core/keyword-identical?","ex__41842__auto__","e62884","statearr-62885","statearr-62886","state__41863__auto__","statearr-62887","cljs.core.async.impl.ioc-helpers/USER-START-IDX","cljs.core.async.impl.ioc-helpers/run-state-machine-wrapped","cljs.core.apply","frontend.handler.file/watch-for-current-graph-dir!","dir","frontend.fs/watch-dir!","frontend.handler.file/create-metadata-file","encrypted?","repo-dir","frontend.config/app-name","frontend.config/metadata-file","file-path","default-content","frontend.fs/mkdir-if-not-exists","file-exists?","frontend.fs.create_if_not_exists","frontend.handler.file/create-pages-metadata-file","frontend.config/pages-metadata-file","frontend.handler.file/edn-file-set-key-value","k","v","frontend.handler.common/read-config","result","frontend.handler.common/parse-config","ks","new-result","borkdude.rewrite-edn/assoc-in"],"sourcesContent":["(ns frontend.handler.file\n  (:refer-clojure :exclude [load-file])\n  (:require [\"/frontend/utils\" :as utils]\n            [borkdude.rewrite-edn :as rewrite]\n            [cljs-time.coerce :as tc]\n            [cljs-time.core :as t]\n            [cljs.core.async.interop :refer [<p!]]\n            [clojure.core.async :as async]\n            [frontend.config :as config]\n            [frontend.db :as db]\n            [frontend.fs :as fs]\n            [frontend.fs.nfs :as nfs]\n            [frontend.handler.common :as common-handler]\n            [logseq.graph-parser.extract :as extract]\n            [frontend.handler.ui :as ui-handler]\n            [frontend.state :as state]\n            [frontend.util :as util]\n            [logseq.graph-parser.util :as gp-util]\n            [logseq.graph-parser.config :as gp-config]\n            [lambdaisland.glogi :as log]\n            [promesa.core :as p]\n            [frontend.mobile.util :as mobile]\n            [clojure.set :as set]))\n\n;; TODO: extract all git ops using a channel\n\n(defn load-file\n  [repo-url path]\n  (->\n   (p/let [content (fs/read-file (config/get-repo-dir repo-url) path)]\n     content)\n   (p/catch\n       (fn [e]\n         (println \"Load file failed: \" path)\n         (js/console.error e)))))\n\n(defn load-multiple-files\n  [repo-url paths]\n  (doall\n   (mapv #(load-file repo-url %) paths)))\n\n(defn- keep-formats\n  [files formats]\n  (filter\n   (fn [file]\n     (let [format (gp-util/get-format file)]\n       (contains? formats format)))\n   files))\n\n(defn- only-text-formats\n  [files]\n  (keep-formats files (config/text-formats)))\n\n(defn- only-image-formats\n  [files]\n  (keep-formats files (config/img-formats)))\n\n(defn restore-config!\n  ([repo-url project-changed-check?]\n   (restore-config! repo-url nil project-changed-check?))\n  ([repo-url config-content _project-changed-check?]\n   (let [config-content (if config-content config-content\n                            (common-handler/get-config repo-url))]\n     (when config-content\n       (common-handler/reset-config! repo-url config-content)))))\n\n(defn load-files-contents!\n  [repo-url files ok-handler]\n  (let [images (only-image-formats files)\n        files (only-text-formats files)]\n    (-> (p/all (load-multiple-files repo-url files))\n        (p/then (fn [contents]\n                  (let [file-contents (cond->\n                                        (zipmap files contents)\n\n                                        (seq images)\n                                        (merge (zipmap images (repeat (count images) \"\"))))\n                        file-contents (for [[file content] file-contents]\n                                        {:file/path (gp-util/path-normalize file)\n                                         :file/content content})]\n                    (ok-handler file-contents))))\n        (p/catch (fn [error]\n                   (log/error :nfs/load-files-error repo-url)\n                   (log/error :exception error))))))\n\n(defn- page-exists-in-another-file\n  \"Conflict of files towards same page\"\n  [repo-url page file]\n  (when-let [page-name (:block/name page)]\n    (let [current-file (:file/path (db/get-page-file repo-url page-name))]\n      (when (not= file current-file)\n       current-file))))\n\n(defn reset-file!\n  ([repo-url file content]\n   (reset-file! repo-url file content false))\n  ([repo-url file content new-graph?]\n   (let [electron-local-repo? (and (util/electron?)\n                                   (config/local-db? repo-url))\n         file (cond\n                (and electron-local-repo?\n                     util/win32?\n                     (utils/win32 file))\n                file\n\n                (and electron-local-repo? (or\n                                           util/win32?\n                                           (not= \"/\" (first file))))\n                (str (config/get-repo-dir repo-url) \"/\" file)\n\n                (and (mobile/native-android?) (not= \"/\" (first file)))\n                file\n\n                (and (mobile/native-ios?) (not= \"/\" (first file)))\n                file\n\n                :else\n                file)\n         file (gp-util/path-normalize file)\n         new? (nil? (db/entity [:file/path file]))]\n     (db/set-file-content! repo-url file content)\n     (let [format (gp-util/get-format file)\n           file-content [{:file/path file}]\n           tx (if (contains? gp-config/mldoc-support-formats format)\n                (let [[pages blocks]\n                      (extract/extract-blocks-pages\n                       file\n                       content\n                       {:user-config (state/get-config)\n                        :date-formatter (state/get-date-formatter)\n                        :page-name-order (state/page-name-order)\n                        :block-pattern (config/get-block-pattern format)\n                        :supported-formats (config/supported-formats)\n                        :db (db/get-db (state/get-current-repo))})\n                      first-page (first pages)\n                      delete-blocks (->\n                                     (concat\n                                      (db/delete-file-blocks! repo-url file)\n                                      (when first-page (db/delete-page-blocks repo-url (:block/name first-page))))\n                                     (distinct))\n                      _ (when-let [current-file (page-exists-in-another-file repo-url first-page file)]\n                          (when (not= file current-file)\n                            (let [error (str \"Page already exists with another file: \" current-file \", current file: \" file)]\n                              (state/pub-event! [:notification/show\n                                                 {:content error\n                                                  :status :error\n                                                  :clear? false}]))))\n                      block-ids (map (fn [block] {:block/uuid (:block/uuid block)}) blocks)\n                      block-refs-ids (->> (mapcat :block/refs blocks)\n                                          (filter (fn [ref] (and (vector? ref)\n                                                                 (= :block/uuid (first ref)))))\n                                          (map (fn [ref] {:block/uuid (second ref)}))\n                                          (seq))\n                      ;; To prevent \"unique constraint\" on datascript\n                      block-ids (set/union (set block-ids) (set block-refs-ids))\n                      pages (extract/with-ref-pages pages blocks)\n                      pages-index (map #(select-keys % [:block/name]) pages)]\n                  ;; does order matter?\n                  (concat file-content pages-index delete-blocks pages block-ids blocks))\n                file-content)\n           tx (concat tx [(let [t (tc/to-long (t/now))] ;; TODO: use file system timestamp?\n                            (cond->\n                              {:file/path file}\n                              new?\n                              (assoc :file/created-at t)))])]\n       (db/transact! repo-url tx (when new-graph? {:new-graph? true}))))))\n\n;; TODO: Remove this function in favor of `alter-files`\n(defn alter-file\n  [repo path content {:keys [reset? re-render-root? from-disk? skip-compare? new-graph?]\n                      :or {reset? true\n                           re-render-root? false\n                           from-disk? false\n                           skip-compare? false}}]\n  (let [original-content (db/get-file repo path)\n        write-file! (if from-disk?\n                      #(p/resolved nil)\n                      #(fs/write-file! repo (config/get-repo-dir repo) path content\n                                       (assoc (when original-content {:old-content original-content})\n                                              :skip-compare? skip-compare?)))]\n    (if reset?\n      (do\n        (when-let [page-id (db/get-file-page-id path)]\n          (db/transact! repo\n            [[:db/retract page-id :block/alias]\n             [:db/retract page-id :block/tags]]))\n        (reset-file! repo path content new-graph?))\n      (db/set-file-content! repo path content))\n    (util/p-handle (write-file!)\n                   (fn [_]\n                     (when (= path (config/get-config-path repo))\n                       (restore-config! repo true))\n                     (when (= path (config/get-custom-css-path repo))\n                       (ui-handler/add-style-if-exists!))\n                     (when re-render-root? (ui-handler/re-render-root!)))\n                   (fn [error]\n                     (println \"Write file failed, path: \" path \", content: \" content)\n                     (log/error :write/failed error)))))\n\n(defn set-file-content!\n  [repo path new-content]\n  (alter-file repo path new-content {:reset? false\n                                     :re-render-root? false}))\n\n(defn alter-files\n  [repo files {:keys [reset? update-db?]\n               :or {reset? false\n                    update-db? true}\n               :as opts}]\n  ;; old file content\n  (let [file->content (let [paths (map first files)]\n                        (zipmap paths\n                                (map (fn [path] (db/get-file repo path)) paths)))]\n    ;; update db\n    (when update-db?\n      (doseq [[path content] files]\n        (if reset?\n          (reset-file! repo path content)\n          (db/set-file-content! repo path content))))\n\n    (when-let [chan (state/get-file-write-chan)]\n      (let [chan-callback (:chan-callback opts)]\n        (async/put! chan [repo files opts file->content])\n        (when chan-callback\n          (chan-callback))))))\n\n(defn alter-files-handler!\n  [repo files {:keys [finish-handler chan]} file->content]\n  (let [write-file-f (fn [[path content]]\n                       (when path\n                         (let [original-content (get file->content path)]\n                          (-> (p/let [_ (or\n                                         (util/electron?)\n                                         (nfs/check-directory-permission! repo))]\n                                (fs/write-file! repo (config/get-repo-dir repo) path content\n                                                {:old-content original-content}))\n                              (p/catch (fn [error]\n                                         (state/pub-event! [:notification/show\n                                                            {:content (str \"Failed to save the file \" path \". Error: \"\n                                                                           (str error))\n                                                             :status :error\n                                                             :clear? false}])\n                                         (state/pub-event! [:instrument {:type :write-file/failed\n                                                                         :payload {:path path\n                                                                                   :content-length (count content)\n                                                                                   :error-str (str error)\n                                                                                   :error error}}])\n                                         (log/error :write-file/failed {:path path\n                                                                        :content content\n                                                                        :error error})))))))\n        finish-handler (fn []\n                         (when finish-handler\n                           (finish-handler))\n                         (ui-handler/re-render-file!))]\n    (-> (p/all (map write-file-f files))\n        (p/then (fn []\n                  (finish-handler)\n                  (when chan\n                    (async/put! chan true))))\n        (p/catch (fn [error]\n                   (println \"Alter files failed:\")\n                   (js/console.error error)\n                   (async/put! chan false))))))\n\n(defn run-writes-chan!\n  []\n  (let [chan (state/get-file-write-chan)]\n    (async/go-loop []\n      (let [args (async/<! chan)]\n        ;; return a channel\n        (try\n          (<p! (apply alter-files-handler! args))\n          (catch js/Error e\n            (log/error :file/write-failed e))))\n      (recur))\n    chan))\n\n(defn watch-for-current-graph-dir!\n  []\n  (when-let [repo (state/get-current-repo)]\n    (when-let [dir (config/get-repo-dir repo)]\n      (fs/watch-dir! dir))))\n\n(defn create-metadata-file\n  [repo-url encrypted?]\n  (let [repo-dir (config/get-repo-dir repo-url)\n        path (str config/app-name \"/\" config/metadata-file)\n        file-path (str \"/\" path)\n        default-content (if encrypted? \"{:db/encrypted? true}\" \"{}\")]\n    (p/let [_ (fs/mkdir-if-not-exists (str repo-dir \"/\" config/app-name))\n            file-exists? (fs/create-if-not-exists repo-url repo-dir file-path default-content)]\n      (when-not file-exists?\n        (reset-file! repo-url path default-content)))))\n\n(defn create-pages-metadata-file\n  [repo-url]\n  (let [repo-dir (config/get-repo-dir repo-url)\n        path (str config/app-name \"/\" config/pages-metadata-file)\n        file-path (str \"/\" path)\n        default-content \"{}\"]\n    (p/let [_ (fs/mkdir-if-not-exists (str repo-dir \"/\" config/app-name))\n            file-exists? (fs/create-if-not-exists repo-url repo-dir file-path default-content)]\n      (when-not file-exists?\n        (reset-file! repo-url path default-content)))))\n\n(defn edn-file-set-key-value\n  [path k v]\n  (when-let [repo (state/get-current-repo)]\n    (when-let [content (db/get-file path)]\n      (common-handler/read-config content)\n      (let [result (common-handler/parse-config content)\n            ks (if (vector? k) k [k])\n            new-result (rewrite/assoc-in result ks v)\n            new-content (str new-result)]\n        (set-file-content! repo path new-content)))))\n"]}