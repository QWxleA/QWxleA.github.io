{"version":3,"sources":["frontend/search/browser.cljs"],"mappings":"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","names":["p__57283","map__57284","cljs.core/--destructure-map","cljs.core.get","frontend.search.browser/search-blocks","repo","q","limit","page","indice","or__4253__auto__","cljs.core/deref","cljs.core.get_in","frontend.search.db/indices","frontend.search.db/make-blocks-indice!","result","cljs.core/clj->js","cljs-bean.core/->clj","cljs.core.map","p__57285","map__57286","item","matches","map__57287","content","uuid","cljs.core.remove","cljs.core/nil?","this__4502__auto__","k__4503__auto__","this__4504__auto__","k57289","else__4505__auto__","G__57297","cljs.core/Keyword","__extmap","this__4522__auto__","f__4523__auto__","init__4524__auto__","cljs.core.reduce","ret__4525__auto__","p__57304","vec__57305","k__4526__auto__","cljs.core.nth","v__4527__auto__","this__4517__auto__","writer__4518__auto__","opts__4519__auto__","pr-pair__4520__auto__","keyval__4521__auto__","cljs.core/pr-sequential-writer","cljs.core.concat","cljs.core/PersistentVector","G__57288","cljs.core/RecordIter","cljs.core/-iterator","cljs.core/nil-iter","this__4500__auto__","__meta","this__4497__auto__","__hash","this__4506__auto__","cljs.core/count","this__4498__auto__","h__4360__auto__","coll__4499__auto__","cljs.core/hash-unordered-coll","this57290","other57291","cljs.core._EQ_","this__4512__auto__","k__4513__auto__","cljs.core/contains?","cljs.core.dissoc","cljs.core/-with-meta","cljs.core.into","cljs.core/not-empty","this__4509__auto__","G__57321","this__4510__auto__","k__4511__auto__","pred__57322","cljs.core/keyword-identical?","expr__57323","cljs.core.assoc","this__4515__auto__","cljs.core/seq","cljs.core/MapEntry","this__4501__auto__","this__4507__auto__","entry__4508__auto__","cljs.core/vector?","cljs.core/-nth","cljs.core/-conj","cljs.core/PROTOCOL_SENTINEL","p__57328","map__57329","frontend.search.browser/Browser","this__4546__auto__","cljs.core/List","writer__4547__auto__","cljs.core/-write","G__57292","extmap__4542__auto__","G__57341","cljs.core/record?","frontend.search.browser/->Browser","frontend.search.browser/map->Browser","_this","option","promesa.core.promise","_repo","blocks-to-remove-set","blocks-to-add","cljs.core.swap_BANG_","cljs.core/update-in","seq__57330","chunk__57331","count__57332","i__57333","temp__5720__auto__","cljs.core/chunked-seq?","c__4679__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/first","cljs.core/next","block-id","block","frontend.search.browser.goog$module$goog$object.get","seq__57335","chunk__57336","count__57337","i__57338","cljs-bean.core/->js","cljs.core/assoc-in"],"sourcesContent":["(ns frontend.search.browser\n  (:require [cljs-bean.core :as bean]\n            [frontend.search.db :as search-db :refer [indices]]\n            [frontend.search.protocol :as protocol]\n            [goog.object :as gobj]\n            [promesa.core :as p]))\n\n;; fuse.js\n\n(defn search-blocks\n  [repo q {:keys [limit page]\n            :or {limit 20}}]\n  (let [indice (or (get-in @indices [repo :blocks])\n                   (search-db/make-blocks-indice! repo))\n        result\n        (if page\n          (.search indice\n                   (clj->js {:$and [{\"page\" page} {\"content\" q}]})\n                   (clj->js {:limit limit}))\n          (.search indice q (clj->js {:limit limit})))\n        result (bean/->clj result)]\n    (->>\n     (map\n       (fn [{:keys [item matches]}]\n         (let [{:keys [content uuid page]} item]\n           {:block/uuid uuid\n            :block/content content\n            :block/page page\n            :search/matches matches}))\n       result)\n     (remove nil?))))\n\n(defrecord Browser [repo]\n  protocol/Engine\n  (query [_this q option]\n    (p/promise (search-blocks repo q option)))\n  (rebuild-blocks-indice! [_this]\n    (let [indice (search-db/make-blocks-indice! repo)]\n      (p/promise indice)))\n  (cache-stale? [_this _repo] (p/promise false)) ;; fuse.js doesn't have cache\n  (transact-blocks! [_this {:keys [blocks-to-remove-set\n                                  blocks-to-add]}]\n    (swap! search-db/indices update-in [repo :blocks]\n           (fn [indice]\n             (when indice\n               (doseq [block-id blocks-to-remove-set]\n                 (.remove indice\n                          (fn [block]\n                            (= block-id (gobj/get block \"id\")))))\n               (when (seq blocks-to-add)\n                 (doseq [block blocks-to-add]\n                   (.add indice (bean/->js block)))))\n             indice)))\n  (truncate-blocks! [_this]\n    (swap! indices assoc-in [repo :blocks] nil))\n  (remove-db! [_this]\n    nil))\n"]}